<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/libs/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/libs/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Leaf Photo, iOS" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Alicia's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Alicia's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Alicia's Blog">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6267334170712737000,
      author: 'Alicia'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> Alicia's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?cbbd9aa76d6f5e7b8019ca96dba4e7e2";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Alicia's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">［LEAF Photo］作者</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/17/About-Message-send-to-dealloc-instance/" itemprop="url">
                  About Message send to dealloc instance
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-17T21:43:04+08:00" content="2016-11-17">
              2016-11-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近，遇到一个崩溃问题，崩溃前控制台打印出 “message send to dealloc instance”，在解决问题的过程中发现一个调试工具。</p>
<p>话说，这一次的问题主要是发生在 MRC 环境下，除了发现调试工具，还回忆了一下 MRC。感兴趣的话，可以当作面试题来看下下面代码有什么问题。</p>
<p>上一次用到 MRC 恐怕还是 2011 年，这次是因为公司有个老代码使用的是很早以前别人写的库，一直没有升级所以还是在 MRC 下。这次有需求要改动这个库，在手生的情况下，一不小心就写错导致崩溃了，先来描述下问题。</p>
<h3 id="崩溃代码"><a href="#崩溃代码" class="headerlink" title="崩溃代码"></a>崩溃代码</h3><p>重要的事情说三遍，MRC 下，MRC 下，MRC 下</p>
<pre><code>//.h 头文件中定义了一个变量
NSString *_title;
//.m 实现文件中
- (id)initWithTitle:(NSString *)title {
    _title = [title copy];
    // … 
}
- (void)dealloc  {
    [_title release];
    [super dealloc];
}
// 另一个调用文件中是这样子的
[[xxClass alloc] initWithTitle:nil];
</code></pre><p>最近的一次修改导致崩溃是被改成了下面的样子，当 title 为 nil 时把它定义为默认字符串，于是上面的 initWithTitle 改为</p>
<pre><code>- (id)initWithTitle:(NSString *)title {
    if (title) {
        _title = [title copy];
    } else {
        _title = NSLocalizedString(@&quot;提示&quot;, nil);
    }
}
</code></pre><p>接下来的事情是这样的，某个页面在多次调用 initWithTitle 的时候会发生崩溃，错误信息是这样子的：</p>
<pre><code>UncaughtExceptionHandlerAddressesKey = (
4   CoreFoundation                      0x1b9ca81c &lt;redacted&gt; + 2124,
5   CoreFoundation                      0x1b9c9f8f CFDictionaryGetValue + 126,
6   CoreFoundation                      0x1bb1446b &lt;redacted&gt; + 142,
7   CoreFoundation                      0x1bb14111 CFBundleCopyLocalizedStringForLocalization + 94,
8   CoreFoundation                      0x1ba0f6bb CFBundleCopyLocalizedString + 18,
</code></pre><p>调试的话，崩溃的位置就在 _title = NSLocalizedString(@”提示”, nil); 这一行。</p>
<p>不知道各位看官是否一眼发现了问题，控制台还有这样的输出</p>
<p>message sent to deallocated instance 0x6d564f0</p>
<p>一时没想到 NSLocalizedString 会有什么问题，因为好久不用 MRC，武功已经全废，所以关注上了这个 message sent to deallocated instance，想通过这条信息查找到问题。</p>
<h3 id="malloc-history-的使用"><a href="#malloc-history-的使用" class="headerlink" title="malloc_history 的使用"></a>malloc_history 的使用</h3><p>网上一通搜索，发现果然能查到 0x6d564f0 这个地址对应的代码，只要在 Xcode -&gt; Scheme -&gt; Arguments 设置中添加环境变量 MallocStackLogging 为 YES，在终端输入下列命令即可</p>
<p>malloc_history 32009 0x6d564f0</p>
<p>其中 32009 是 pid，pid 在 Xcode 的控制台会打印（这个方法只能检测模拟器上的问题），如下</p>
<p>2016-11-17 16:19:57:837 MyProject[32009:304745]</p>
<p>命令执行后输出，终端输出</p>
<p>Invalid connection: com.apple.coresymbolicationd<br>malloc_history Report Version:  2.0<br>ALLOC 0x7b786d90-0x7b786d9f [size=16]: thread_92ec000 | start | main | UIApplicationMain | -[UIApplication _run] | CFRunLoopRunInMode | CFRunLoopRunSpecific | <strong>CFRunLoopDoObservers | </strong>CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION<strong> | CA::Transaction::observer_callback(</strong>CFRunLoopObserver<em>, unsigned long, void</em>) | CA::Transaction::commit() | CA::Context::commit_transaction(CA::Transaction<em>) | CA::Layer::layout_and_display_if_needed(CA::Transaction</em>) | CA::Layer::layout_if_needed(CA::Transaction*) | -[CALayer layoutSublayers] | -[NSObject performSelector:withObject:] | -[UIView(CALayerDelegate) layoutSublayersOfLayer:] | -[UILayoutContainerView layoutSubviews] | -[UINavigationController <strong>viewWillLayoutSubviews] | -[UINavigationController _startDeferredTransitionIfNeeded:] | -[UINavigationController _startTransition:fromViewController:toViewController:] | -[UINavigationController _updateScrollViewFromViewController:toViewController:] | -[UINavigationController _layoutViewController:] | -[UIViewController loadViewIfRequired] | -[UIViewController _sendViewDidLoadWithAppearanceProxyObjectTaggingEnabled] | -[WSLoginViewController viewDidLoad] | -[WSLoginViewController createLoginBoxView] | -[WSLoginViewController createTextField] | -[NSBundle localizedStringForKey:value:table:] | CFBundleCopyLocalizedString | CFBundleCopyLocalizedStringForLocalization | _copyStringFromTable | CFPropertyListCreateWithData | _CFPropertyListCreateWithData | </strong>CFTryParseBinaryPlist | <strong>CFBinaryPlistCreateObjectFiltered | </strong>CFBinaryPlistCreateObjectFiltered | CFStringCreateWithCharacters | <strong>CFStringCreateImmutableFunnel3 | _CFRuntimeCreateInstance | CFAllocatorAllocate | </strong>CFAllocatorSystemAllocate</p>
<p>哇，这么长，怎么看，其实只要关注最后面的几句</p>
<pre><code>[WSLoginViewController createTextField] | -[NSBundle localizedStringForKey:value:table:] | CFBundleCopyLocalizedString
</code></pre><p>这里能</p>
<h3 id="揭秘崩溃原因"><a href="#揭秘崩溃原因" class="headerlink" title="揭秘崩溃原因"></a>揭秘崩溃原因</h3><p>还是回到原始吧，就看 _title = NSLocalizedString(@”提示”, nil); 再想想是在 MRC 下啊，突然脑袋一开窍就想到了，直接赋值静态字符串是不需要释放的，dealloc 的时候会有 release 调用，所以改成了如下方式</p>
<pre><code>_title = [[NSString alloc] initWithString:NSLocalizedString(@&quot;提示&quot;, nil)];
</code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>虽然平时已经好久不用 MRC 了，但是发现个 malloc_history 也还不错。</p>
<h3 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h3><p><a href="http://blog.csdn.net/lgm252008/article/details/17436177" target="_blank" rel="external">message sent to deallocated instance问题的解决方法</a><br><a href="http://blog.csdn.net/u013247242/article/details/43491467" target="_blank" rel="external">内存管理的简单总结</a><br><a href="http://blog.csdn.net/freewaywalker/article/details/45623433" target="_blank" rel="external">Xcode 调试</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/11/Source-Code-Learning-JDStatusBarNotification/" itemprop="url">
                  Source Code Learning JDStatusBarNotification
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-10-11T19:41:33+08:00" content="2016-10-11">
              2016-10-11
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="RunLoop-和-NSTimer"><a href="#RunLoop-和-NSTimer" class="headerlink" title="RunLoop 和 NSTimer"></a>RunLoop 和 NSTimer</h3><p>每次显示时先要将之前设置过的 timer 取消</p>
<pre><code>// cancel previous dismissing &amp; remove animations
[[NSRunLoop currentRunLoop] cancelPerformSelector:@selector(dismiss) target:self argument:nil];
</code></pre><p>timer 的设置代码如下：</p>
<pre><code>- (void)setDismissTimerWithInterval:(NSTimeInterval)interval; {
    [self.dismissTimer invalidate];             // 重新赋值时先要使其无效
    self.dismissTimer = [[NSTimer alloc] initWithFireDate:[NSDate dateWithTimeIntervalSinceNow:interval]
                                             interval:0 target:self selector:@selector(dismiss:) userInfo:nil repeats:NO];
    [[NSRunLoop currentRunLoop] addTimer:self.dismissTimer forMode:NSRunLoopCommonModes];
}
</code></pre><p>为了能在用户拖拽页面的时候 timer 正确计时，将 timer 添加到 NSRunLoopCommonModes 模式下</p>
<h3 id="UIWindowLevel"><a href="#UIWindowLevel" class="headerlink" title="UIWindowLevel"></a>UIWindowLevel</h3><p>每个应用都有一个主 window，通常在 AppDelegate 中设置</p>
<pre><code>self.window = [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];
self.window.backgroundColor = [UIColor whiteColor];
self.window.rootViewController = [[UINavigationController alloc] initWithRootViewController:
                                  [[SBExampleViewController alloc] initWithStyle:UITableViewStyleGrouped]];

[self.window makeKeyAndVisible];
</code></pre><p>makeKeyAndVisible 方法是将某个 window 设置为主窗口并设置为可见，这个窗口的级别使用默认值 UIWindowLevelNormal，UIWindowLevel 的级别如下</p>
<pre><code>UIKIT_EXTERN const UIWindowLevel UIWindowLevelNormal;
UIKIT_EXTERN const UIWindowLevel UIWindowLevelAlert;
UIKIT_EXTERN const UIWindowLevel UIWindowLevelStatusBar __TVOS_PROHIBITED;
</code></pre><p>其级别顺序是 Normal &lt; StatusBar &lt; Alert，也就是说 Alert 级别的 window 会在最前端显示。</p>
<p>其中 UIKIT_EXTERN 的定义如下</p>
<pre><code>#ifdef __cplusplus
#define UIKIT_EXTERN        extern &quot;C&quot; __attribute__((visibility (&quot;default&quot;)))
#else
#define UIKIT_EXTERN            extern __attribute__((visibility (&quot;default&quot;)))
#endif
</code></pre><p>这几个变量的定义在该文件中可见</p>
<p>extern “C”是连接申明(linkage declaration),被extern “C”修饰的变量和函数是按照C语言方式编译和连接的</p>
<p>所以我们如果用 AppDelegate 中创建的这个最低级别作为显示状态栏的窗口的话，很可能会被遮盖，所以首先要创建一个状态栏级别的窗口，创建窗口的代码见 - (UIWindow *)overlayWindow; 方法。</p>
<pre><code>self.overlayWindow = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];
self.overlayWindow.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
self.overlayWindow.backgroundColor = [UIColor redColor];
self.overlayWindow.userInteractionEnabled = NO;
self.overlayWindow.windowLevel = UIWindowLevelStatusBar;
self.overlayWindow.rootViewController = [[UIViewController alloc] init];
self.overlayWindow.rootViewController.view.backgroundColor = [UIColor clearColor];
self.overlayWindow.hidden = NO;
</code></pre><p>需要注意的是，窗口创建后默认是不显示的，设置 hidden 为 NO 即可显示，如上我们创建了一个红色的窗口，它可以和 AppDelegate 中设置的主窗口并存，由于它的级别高，所以完全覆盖了主窗口显示红色。</p>
<h3 id="屏幕旋转"><a href="#屏幕旋转" class="headerlink" title="屏幕旋转"></a>屏幕旋转</h3><p>当屏幕旋转时，我们创建的 overlayWindow 也要处理旋转，它的旋转 transform 应当和主窗口相同，mainApplicationWindowIgnoringWindow 方法用来获取主窗口，之后将 overlayWindow 的 transform 和 frame 设置为主窗口一致即可，overlayWindow 中的 topBar 的 frame 也需要重新设置。</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="http://www.cnblogs.com/smileEvday/archive/2012/11/16/UIWindow.html" target="_blank" rel="external">UIWindow的一点儿思考</a><br><a href="http://www.cnblogs.com/smileEvday/archive/2013/05/30/statusBarTips.html" target="_blank" rel="external">状态栏提示控件的实现原理</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/23/Clang-Attributes-in-Open-Source/" itemprop="url">
                  Clang Attributes in Open Source
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-23T19:37:56+08:00" content="2016-09-23">
              2016-09-23
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇文章应该叫做那些开源项目中用到过的 Clang Attributes，会列出开源项目的名字和使用方式以及用例</p>
<h3 id="visibility"><a href="#visibility" class="headerlink" title="visibility"></a>visibility</h3><h5 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h5><p><strong>attribute</strong> ((visibility(“default”)))</p>
<p>visibility 中的值可以为 default | internal | hidden | protected</p>
<p>该属性用于设置动态链接库中函数或者变量的可见性</p>
<p>我们在 C 语言中，如果想要将函数或变量限制在当前文件中，可以使用 static 关键字，但是在复杂的项目中，如果想要限制某个符号被共享库内部某些文件可以访问，而外部不可以访问泽有些困难，于是 GCC 中引入了 visibility 属性，它可以设置某个函数或变量是否可访问，例如这个变量在多个文件中被定义，又同时有多个链接库需要引用它时，如果不设置可见性，那么到底引用为那个值或者函数就要看加载顺序了。</p>
<h5 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h5><pre><code>UIKIT_EXTERN const UIWindowLevel UIWindowLevelNormal;
UIKIT_EXTERN const UIWindowLevel UIWindowLevelAlert;
UIKIT_EXTERN const UIWindowLevel UIWindowLevelStatusBar __TVOS_PROHIBITED;

#ifdef __cplusplus
#define UIKIT_EXTERN        extern &quot;C&quot; __attribute__((visibility (&quot;default&quot;)))
#else
#define UIKIT_EXTERN            extern __attribute__((visibility (&quot;default&quot;)))
#endif
</code></pre><h5 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h5><p>JDStatusBarNotification</p>
<h5 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h5><p><a href="https://gcc.gnu.org/onlinedocs/gcc-4.3.5/gcc/Function-Attributes.html" target="_blank" rel="external">Visibility Pragmas</a><br><a href="https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/CppRuntimeEnv/Articles/SymbolVisibility.html" target="_blank" rel="external">Controlling Symbol Visibility</a></p>
<h3 id="objc-subclassing-restricted"><a href="#objc-subclassing-restricted" class="headerlink" title="objc_subclassing_restricted"></a>objc_subclassing_restricted</h3><h5 id="解释-1"><a href="#解释-1" class="headerlink" title="解释"></a>解释</h5><pre><code>__attribute__((objc_subclassing_restricted))
</code></pre><p>用于限制某个类是不可继承的，但是这个限制只是编译时的限制，不直接写 @interface SubClass : ParentClass，而是使用 Runtime 的方式仍然是可以创建继承关系的。</p>
<pre><code>void run(id self, SEL _cmd) {}
class subClass = objc_allocateClassPair([ParentClass class], &quot;SubClass&quot;, 0);
class_addMethod(subClass, @selector(run),(IMP) run, &quot;v@:&quot;);
objc_registerClassPair(subClass);
</code></pre><h5 id="用例-1"><a href="#用例-1" class="headerlink" title="用例"></a>用例</h5><p><strong>attribute</strong>((objc_subclassing_restricted))<br>@interface ParentClass : NSObject<br>@end<br>@interface SubClass : ParentClass // &lt;— Compile Error<br>@end</p>
<h5 id="参考文献-1"><a href="#参考文献-1" class="headerlink" title="参考文献"></a>参考文献</h5><p><a href="http://blog.sunnyxx.com/2016/05/14/clang-attributes/" target="_blank" rel="external">Clang Attributes 黑魔法小记</a></p>
<h3 id="deprecated"><a href="#deprecated" class="headerlink" title="deprecated"></a>deprecated</h3><h5 id="解释-2"><a href="#解释-2" class="headerlink" title="解释"></a>解释</h5><pre><code>__attribute__((deprecated(&quot;弃用解释说明&quot;)));
</code></pre><p>用于说明某个属性已经弃用</p>
<p>@property (assign, nonatomic) CGFloat opacity <strong>attribute</strong>((deprecated(“Customize bezelView properties instead.”)));</p>
<h5 id="用例-2"><a href="#用例-2" class="headerlink" title="用例"></a>用例</h5><p>另外，忽略弃用警告可以使用</p>
<pre><code>#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wdeprecated-declarations&quot;
self.bezelView.alpha = self.opacity;
#pragma clang diagnostic pop
</code></pre><h5 id="项目-1"><a href="#项目-1" class="headerlink" title="项目"></a>项目</h5><p>MBProgress</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/05/Writing-Crash-Free-Code/" itemprop="url">
                  Writing Crash-Free Code
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-05T17:03:07+08:00" content="2016-09-05">
              2016-09-05
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>面试的时候经常会被问到“程序崩溃都有哪些原因造成”，突然想的话想不到那么全面， 总结一下以备不时之需，也可以在写代码时注意下。另外，“如何处理崩溃”也是面试官喜欢问的问题，也做个总结。</p>
<h3 id="程序崩溃都有哪些原因造成"><a href="#程序崩溃都有哪些原因造成" class="headerlink" title="程序崩溃都有哪些原因造成"></a>程序崩溃都有哪些原因造成</h3><ul>
<li>可变数组的操作<ol>
<li>使用 (for in) 或迭代器遍历可变数组时删除数组元素，改为逆序遍历或者添加个数组副本</li>
<li>可变数组声明属性为 copy<br> // .h 文件<br> @property (nonatomic, copy) NSMutableArray <em>mutableArray;<br> // .m 文件<br> NSMutableArray </em>array = @[@1,@2];<br> self.mutableArray = array;<br> // 下句崩溃，因为 NSArray 中找不到 removeObjectAtIndex 方法<br> [self.mutableArray removeObjectAtIndex:0];  </li>
</ol>
</li>
<li>NSNotification addObserver 使用后没有（在 dealloc 中） removeObserver，或者 delegate 使用后没有置为 nil</li>
<li>多线程中访问同一块资源时，没有为数据加锁，数据错误可能会导致崩溃。另外在多线程中，UI 等操作需要放到主线程操作，否则会导致崩溃</li>
<li>操作野指针，或者对空进行操作，可以使用 NSParameterAssert 等进行判断</li>
<li>数组越界</li>
<li>调用对象不存在的方法</li>
<li>低内存终止，看门狗结束程序，大多是内存泄漏等导致。</li>
</ul>
<h3 id="修复线上崩溃的方法"><a href="#修复线上崩溃的方法" class="headerlink" title="修复线上崩溃的方法"></a>修复线上崩溃的方法</h3><h4 id="使用-symbolicatecrash-工具将崩溃堆栈符号化"><a href="#使用-symbolicatecrash-工具将崩溃堆栈符号化" class="headerlink" title="使用 symbolicatecrash 工具将崩溃堆栈符号化"></a>使用 symbolicatecrash 工具将崩溃堆栈符号化</h4><p>创建新的文件夹，将 symbolicatecrash、.crash 和 .dSYM 文件放到该文件夹下执行下面命令，生成新的 symbol.crash 文件，该文件中可以显示崩溃函数名及位置。</p>
<pre><code>./symbolicatecrash ./*.crash ./*.app.dSYM &gt; symbol.crash
</code></pre><p>发生 Error: “DEVELOPER_DIR” is not defined 错误可在终端继续输入以下指令设置环境变量</p>
<pre><code>export DEVELOPER_DIR=/Applications/XCode.app/Contents/Developer
</code></pre><p>以上三个文件的位置：</p>
<p>symbolicatecrash 可以在终端输入下面命令查找其所在位置</p>
<pre><code>find /Applications/Xcode.app -name symbolicatecrash -type f
</code></pre><p>.crash 文件在 Xcode -&gt; Window -&gt; Organizer -&gt; 选中 App 的 Crashes ，选中需要解决的问题，右键 -&gt; Show in Finder，找到 .xccrashpoint 文件，右键 -&gt; Show Package Content 后打开的目录中包含 .crash 文件</p>
<p>.dSYM 文件在 Xcode -&gt; Window -&gt; Organizer -&gt; 选中 App 的 Archives，右侧面板中 Download dSYMs 后 .xcarchive 中包含 .dSYM 文件</p>
<p>用 Console 工具打开新生成的 .crash 文件，除了能看到崩溃调用堆栈外，还可以看到崩溃的机型、系统等，另外 Exception Type 会显示崩溃原因如 Exception Type:  EXC_CRASH (SIGABRT)</p>
<p>以下列出信号类型，<a href="https://en.wikipedia.org/wiki/C_signal_handling" target="_blank" rel="external">更多点击这里</a></p>
<p>SIGABRT – 程序中止命令中止信号 (通常指由于某个对象接收到未实现的消息引起的)<br>SIGALRM – 程序超时信号<br>SIGFPE – 程序浮点异常信号<br>SIGILL – 程序非法指令信号<br>SIGHUP – 程序终端中止信号<br>SIGINT – 程序键盘中断信号<br>SIGKILL – 程序结束接收中止信号<br>SIGTERM – 程序kill中止信号<br>SIGSTOP – 程序键盘中止信号<br>SIGSEGV – 程序无效内存中止信号 （一般是表示内存不合法）<br>SIGBUS – 程序内存字节未对齐中止信号<br>SIGPIPE – 程序Socket发送失败中止信号</p>
<h4 id="使用-atos"><a href="#使用-atos" class="headerlink" title="使用 atos"></a>使用 atos</h4><p>atos 比较适用于当你把应用发布到多个渠道，需要对不同渠道的 crash 文件进行分析时，或者不确定哪个 dSYM 对应哪个归档文件时使用。</p>
<p>获取崩溃 Build 的唯一标识 UUID<br>如输入</p>
<pre><code>xcrun dwarfdump --uuid appName.app/appName    
</code></pre><p>获取 dSYM 文件的 UUID</p>
<pre><code>xcrun dwarfdump -–uuid appName.app.dSYM
</code></pre><p>如果 .crash、dSYM 以及 app 中的 UUID 都一致说明这三个文件是对应的。</p>
<p>接下来获取崩溃文件的崩溃函数地址</p>
<pre><code>atos [-o AppName.app/AppName] [-l loadAddress] [-arch architecture]
</code></pre><p>如输入</p>
<pre><code>xcrun atos -o appName.app.dSYM/Contents/Resources/DWARF/appName -l 0x1000 -arch armv7
</code></pre><p>则会打印崩溃地址指向的函数名和所在行数</p>
<h4 id="使用友盟"><a href="#使用友盟" class="headerlink" title="使用友盟"></a>使用友盟</h4><p>友盟的崩溃文件下载后使用它自己的工具将崩溃文件生成 cvs 文件</p>
<h4 id="使用第三方工具-BugHd"><a href="#使用第三方工具-BugHd" class="headerlink" title="使用第三方工具 BugHd"></a>使用第三方工具 BugHd</h4><p>该工具可以将崩溃信息和 dSYM 结合查看，<a href="http://bughd.com" target="_blank" rel="external">点击此处查看详情</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/31/Reading-The-Solution-Tango/" itemprop="url">
                  Reading The Solution Tango
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-31T20:14:15+08:00" content="2016-08-31">
              2016-08-31
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近读了一本不错的管理类书籍，《The Solution Tango: Solving any problem in senven easy steps》 译者可能也知道这个英文名字估计不能吸引中国读者，所以他的中文译名是意译的 《不懂带人，你就自己干到死：把身边的庸才变干将》。</p>
<p>做技术的人大多跟机器打交道，并不擅长处理人的关系。当从做技术升级为管理层时，很少和下属沟通，或者弄得下属觉得整天被指手画脚工作地并不舒服；又或是一些下属主动沟通的能力基本没有，被动沟通时又表现出一副不屑或者不愿搭理的样子。前两天还看到有人说，技术很厉害的人凑在一起创业的多了，但是成功的就没有几个了，技术上的问题很容易解决，但是人的问题就没那么容易处理了。</p>
<p>这本书就是解决人的问题的，它提出了一些事例和七个步骤来说明如何带人：</p>
<blockquote>
<p>别再给员工讲道理了，没人听</p>
</blockquote>
<p>当出现问题时，首要需要想想如何解决问题，而不是陷入指责谁是导致问题的原因。</p>
<p>大部分情况下领导在出现问题时都是先追责，追责可以让导致出现问题的人记住教训避免其再犯，或者找出一个人来承担责任。但是书中指出这对问题的解决一点用处没有，而且很容易使人陷入一种负面的情绪中，大家变得沮丧、压抑、毫无斗志，我们应该在出现问题时，及时想办法补救。忘掉为什么，多问怎么办。</p>
<blockquote>
<p>如何听，员工才会说；如何说，员工才会听</p>
</blockquote>
<p>听，不要让自己的先入之见扭曲别人传递的信息。做到这点其实还挺不容易的，我们总是习惯在听人说话时，把自己放在一个更高的位置，认为自己有多么聪明，可以想到别人要表达什么，但是很多时候那只是我们的想法不是别人要说的，倾听时要对他人有耐心。</p>
<p>说，要用宽松而不是指令性的语言，采取邀请的姿态，而不是摆出指挥的架势。想到最近的女排，每次比赛切到郎平指导时，她都是以一种商量的口吻、建议的语气指出队员的问题（“XXX 刚才是不是 XXX 那样更好些？”)。又想到羽毛球，总指导说林丹是那种比较抗压的，可以指出他的问题说他逼他，但是谌龙就不能用这种方式，要用安抚的方式。大家都能接受宽松式的语言，但却有很多人不能接受指令性语言。</p>
<p>书名中提到的解决方案的七个步骤是：</p>
<blockquote>
<p>创建舒服的工作环境，让员工有更好的积极性、创造性去解决问题；</p>
</blockquote>
<p>确保你建立了一个积极且互相尊重的工作关系。还是以郎平为例，训练的时候要严格，但是生活中可以和队员多沟通、照顾，以她的年龄像妈妈一样的关怀队员，做到“威而不怒，亲而不犯”。</p>
<blockquote>
<p>调节员工的情绪，让员工从积极的角度看问题，找到合理的解决办法；</p>
</blockquote>
<p>.</p>
<blockquote>
<p>帮员工把目标分解成一个个动作，让目标清晰有效；</p>
</blockquote>
<p>目标要细化分成小目标，而且目标要清晰，不能是模棱两可的。</p>
<blockquote>
<p>调用你的资源，帮员工解决问题，达到目标；</p>
</blockquote>
<p>帮员工解决问题的三种境界，最底层的境界是撸袖子自己上，然后是告诉他们怎么做，最高的境界是通过提问的方式，引导员工自己想出解决方案，其实就是苏格拉底提问法。</p>
<blockquote>
<p>赞美员工的某个行为，而不是泛泛赞美； </p>
</blockquote>
<p>当其他人让你感觉很好时，你会在自己正在做的事情上表现的更好，所以不要吝惜你的赞美。</p>
<blockquote>
<p>让员工对工作进度做自我评估，让员工找到完成剩余工作的办法； </p>
</blockquote>
<p>.</p>
<blockquote>
<p>引导员工“向前看”，少问“为什么”，多问“怎么办”。</p>
</blockquote>
<p>领导这门艺术不是看一本书就能学会的，想到更多事例的时候再来更新感受，看到更好的书籍还是会来写感受，今天听到马云说要多看书，看书还要多思考。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/30/What-can-make-reading-Github-code-easy/" itemprop="url">
                  What can make reading Github code easy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-30T15:17:58+08:00" content="2016-08-30">
              2016-08-30
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>经常 Github 上逛，某些代码在下载前需要看下大概的逻辑，在网页里点好几层才能看到代码，怎么破？装个插件 Octotree，<a href="https://github.com/buunguyen/octotree" target="_blank" rel="external">源码介绍看这里</a>。</p>
<p><img src="https://github.com/buunguyen/octotree/raw/master/docs/chrome-github.png" alt="img"></p>
<p>不想翻墙就<a href="http://www.cnplugins.com/devtool/octotree/download.html" target="_blank" rel="external">点击这里下载</a>，下载后在 Chrome 中打开一个新 Tab，输入chrome://extensions，把下载的 .crx 文件拖拽到浏览器安装，再打开 Github 页面会出现提示是否使用 Octotree。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/24/GCD-Timer-and-Leaks/" itemprop="url">
                  GCD Timer and Leaks
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-24T21:11:18+08:00" content="2016-08-24">
              2016-08-24
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>GCD 的 Timer 相对于 NSTimer 更加灵活、高效（无需在主线程和后台线程之间进行切换），而且 NSTimer 需要在合适的地方调用 invalid 以避免内存泄漏，所以平时比较常用。但是发现 GCD Timer 随便调用 API 的话也会造成内存泄漏。</p>
<p>GCD Timer 通过 Dispatch Source 实现，调用方法如：</p>
<pre><code>dispatch_queue_t queue = dispatch_get_main_queue();
dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);
dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, 
    2.0 * NSEC_PER_SEC, 0.1 * NSEC_PER_SEC);
dispatch_source_set_event_handler(timer, ^() {
    // do something
});
dispatch_resume(timer);
</code></pre><p>如果需要暂停定时器调用</p>
<pre><code>dispatch_suspend(timer);
</code></pre><p>dispatch_suspend 和 dispatch_resume 应该是成对出现的。两者分别会减少和增加 dispatch 对象的挂起计数，但是没有 API 获取当前是挂起还是执行状态，所以需要自己记录。</p>
<h3 id="dispatch-suspend-暂停队列并不意味着当前执行的-block-暂停"><a href="#dispatch-suspend-暂停队列并不意味着当前执行的-block-暂停" class="headerlink" title="dispatch_suspend 暂停队列并不意味着当前执行的 block 暂停"></a>dispatch_suspend 暂停队列并不意味着当前执行的 block 暂停</h3><p>当暂停派发队列时需要注意，调用 dispatch_suspend 暂停一个队列，并不意味着暂停当前正在执行的 block，而是 block 可以执行完，但是接下来的 block 会被暂停，直到 dispatch_resume 被调用。</p>
<p>如果添加 dispatch_suspend 的调用后 timer 是无法被释放的。一般情况下会发生崩溃并报“EXC_BAD_INSTRUCTION”错误，看下 <a href="http://opensource.apple.com/source/libdispatch/libdispatch-187.7/src/source.c" target="_blank" rel="external">GCD 源码 Source 释放的处理</a> dispatch source release 的时候判断了当前是否是在暂停状态。</p>
<pre><code>void _dispatch_source_xref_release(dispatch_source_t ds) {
    if (slowpath(DISPATCH_OBJECT_SUSPENDED(ds))) {
        // Arguments for and against this assert are within 6705399
        DISPATCH_CLIENT_CRASH(&quot;Release of a suspended object&quot;);
    }
    _dispatch_wakeup(ds);
    _dispatch_release(ds);
}
</code></pre><p><a href="http://libdispatch.macosforge.org/" target="_blank" rel="external">GCD 完整源码点击这里</a></p>
<h3 id="dispatch-suspend-状态下无法释放"><a href="#dispatch-suspend-状态下无法释放" class="headerlink" title="dispatch_suspend 状态下无法释放"></a><span id="dispatch_suspend_dealloc">dispatch_suspend 状态下无法释放</span></h3><p>但是还有不一般的情况，如果暂停的代码加到 dispatch_source_set_event_handler 的 block 中，并不会发生崩溃，但是这个时候页面会无法释放造成内存泄漏！内存泄漏！内存泄漏！。</p>
<pre><code>dispatch_source_set_event_handler(timer, ^() {
    // do something
    dispatch_suspend(timer);
});
</code></pre><p><a href="https://github.com/alicialy/MemoryLeaks" target="_blank" rel="external">Demo 代码点击这里</a>，Demo 中进入“GCD Timer” 页面再退出，通过 Allocations 工具可以发现 GCDTimerViewController 没有释放，dealloc 无法执行。</p>
<p>怎么破？如果有需求按照上面这种方式写的话，添加个变量记录下 dispatch_suspend 是否被调用的状态，在 dealloc 时判断下，调用过 dispatch_suspend 则再调用下 dispatch_resume。或者暂停后不需要重新运行 timer 的话，取消 timer，一旦取消则不能再重新运行 timer，只能重建。</p>
<pre><code>dispatch_source_cancel(timer);
</code></pre><h3 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h3><p><a href="https://www.mikeash.com/pyblog/friday-qa-2009-09-18-intro-to-grand-central-dispatch-part-iv-odds-and-ends.html" target="_blank" rel="external">Mikeash GCD 介绍</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/18/AsyncDisplayKit/" itemprop="url">
                  AsyncDisplayKit
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-07-18T14:41:09+08:00" content="2016-07-18">
              2016-07-18
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>Pinterest 为了 1 亿用户的目标对其 iOS app 进行了重构。这次重构进行的主要改变是使用 AsyncDisplayKit。</p>
<p>ASDK 是用来保证 UIs 的流畅性和可响应性的一个开源库。它可以将图片的解码、文字大小调整及渲染，和其他比较耗时的 UI 处理放到后台线程中进行。除了异步处理这个亮点，它还提供了一种类似 <a href="http://www.w3schools.com/css/css_boxmodel.asp">CSS Box Model</a> 的系统，让你能够像使用 UIView 一样容易的使用 CALayers (无需注册触摸事件)。另外，它还提供了滚动视图移动差值的计算，它可以在获取网络数据后，计算出用户滚动位置的 Cell 区域，提前渲染出一小部分 Cell。</p>
<h2 id="Node-介绍"><a href="#Node-介绍" class="headerlink" title="Node 介绍"></a>Node 介绍</h2><p>UIView 和 CALayer 不是线程安全的，所以无法做到在非主线程中进行操作，所以 ASDK 创建了以 node 为基本单位的对象，需要使用各种 node 来代替之前的各种控件。</p>
<p>node 和 UIKit 的 View 对应关系（摘要）<br>ASDisplayNode       代替 UIKit 的 UIView （AsyncDisplayKit 的根 node）<br>ASCellNode          代替 UIKit 的 UITableViewCell 和 UICollectionViewCell</p>
<p>ASDK 中除了 node 外，还有很多 node containers，不建议单独使用 node，而是应当将其添加到 node containers 中。</p>
<p>node containers 和 UIKit 的 Controller 的对应关系（摘要）<br>ASViewController    代替 UIKit 的 UIViewController</p>
<h2 id="智能预加载"><a href="#智能预加载" class="headerlink" title="智能预加载"></a>智能预加载</h2><p>要将 node 添加到 node containers 中主要是因为所有的 node 都有它们当前接口状态的概念，这个接口状态的属性名称是 interfaceState，由所有容器创建和内部维护的 ASRangeController 进行更新。未添加到容器中的 node 不会收到该状态的更新。</p>
<p>例如当 nodes 被添加到可滚动或者分页的页面中，nodes 通常会在以下的范围内：<br>Fetch Data Range：可见的最远范围。它的内容需要从 API 或者本地磁盘中获取。<br>Display Range：显示任务例如文本栅格化和图片解码。<br>Visible Range：Node 正在屏幕上被显示的</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/07/18/AsyncDisplayKit/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/24/Concurrent-Programming-and-Synchronization/" itemprop="url">
                  Concurrent Programming and Synchronization
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-06-24T19:26:35+08:00" content="2016-06-24">
              2016-06-24
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>使用多线程时，要注意防止不同线程意外修改数据的问题，下面总结一下常用的同步方式。</p>
<h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><p>原子操作是同步的一个简单的形式，它处理简单的数据类型。其优势是不妨碍竞争的线程。对于简单操作，比如递增一个计数器，原子操作比使用锁具有更高的性能优势。 </p>
<pre><code>void retain() {
    OSAtomicIncrement64(&amp;retainCount);    // retainCount 为实例变量，相当于 retainCount++
}
void release() {
    unit32_t originalValue;
    orginalValue = OSAtomicDecrement64(&amp;retainCount); // 相当于 retainCount--
    if (originalValue == 1) {
        this-&gt;free();
    }
}
</code></pre><p>查看支持原子操作的列表，参阅/user/include/libkern/OSAtomic.h头文件和参见 <a href="https://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicTestAndSet.3.html">atomic主页</a>。</p>
<h2 id="内存屏障（Memory-Barrier）"><a href="#内存屏障（Memory-Barrier）" class="headerlink" title="内存屏障（Memory Barrier）"></a>内存屏障（Memory Barrier）</h2><p>内存屏障（Memory Barrier）是用来确保内存操作按照正确顺序工作的非阻塞同步工具。内存屏障的作用就像一个栅栏，迫使处理器来完成位于障碍前面的任何加载和存储操作，才允许它执行位于屏障之后的加载和存储操作。</p>
<p>Volatile 变量适用于独立变量的另一个内存限制类型。编译器优化代码通过加载这些变量的值进入寄存器。对于本地变量，这通常不会有什么问题。但是如果一个变量对另外一个线程可见，那么这种优化可能会阻止其他线程发现变量的任何变化。在变量之前加上关键字 volatile 可以强制编译器每次使用变量的时候都从内存里面加载。如果一个变量的值随时可能给编译器无法检测的外部源更改，那么你可以把该变量声明为volatile变量。</p>
<p>因为内存屏障和volatile变量降低了编译器可执行的优化，因此应该谨慎使用它们，只在有需要的地方时候，以确保正确性。关于更多使用内存屏障的信息，参阅 OSMemoryBarrier 主页。</p>
<pre><code>// ...
OSMemoryBarrier();
// ...
</code></pre><h2 id="锁-互斥锁"><a href="#锁-互斥锁" class="headerlink" title="锁 - 互斥锁"></a>锁 - 互斥锁</h2><p>被这个锁保护的临界区只允许一个线程进入，其他线程如果没有获取得到锁权限，只能等待</p>
<h3 id="POSIX-互斥锁在很多程序里面很容易使用"><a href="#POSIX-互斥锁在很多程序里面很容易使用" class="headerlink" title="POSIX 互斥锁在很多程序里面很容易使用"></a>POSIX 互斥锁在很多程序里面很容易使用</h3><pre><code>pthread_mutex_t mutex;
void MyInitFunction() {
    pthread_mutex_init(&amp;mutex, NULL);
}

void MyLockingFunction() {
    pthread_mutex_lock(&amp;mutex);
    // do something ...
    pthread_mutex_unlock(&amp;mutex);
}
</code></pre><h3 id="NSLock-中实现了一个简单的互斥锁"><a href="#NSLock-中实现了一个简单的互斥锁" class="headerlink" title="NSLock 中实现了一个简单的互斥锁"></a>NSLock 中实现了一个简单的互斥锁</h3><pre><code>NSLock *theLock = [[NSLock alloc] init];
if ([theLock lock]) {
    // do something ...
    [theLock unlock];
}
</code></pre><p>除了标准的锁行为，NSLock 类还增加了 tryLock 和 lockBeforeDate: 方法。方法 tryLock 试图获取一个锁，但是如果锁不可用的时候，它不会阻塞线程。相反，它只是返回 NO。而 lockBeforeDate: 方法试图获取一个锁，但是如果锁没有在规定的时间内被获得，它会让线程从阻塞状态变为非阻塞状态（或者返回 NO ）。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/06/24/Concurrent-Programming-and-Synchronization/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/26/LEAF-Photo/" itemprop="url">
                  LEAF Photo
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-26T23:52:34+08:00" content="2016-05-26">
              2016-05-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/post_images/leafphoto1.gif" width="300px" class="fancybox"></p>
<p><img src="/post_images/leafphoto2.gif" width="300px" class="fancybox"></p>
<p><a href="https://itunes.apple.com/us/app/leaf-photo/id1117744396?l=zh&amp;ls=1&amp;mt=8" target="_blank" rel="external">Download now!</a></p>
<p>LEAF Photo - Edit your photos easy.</p>
<p>Design Tools: Templates, Text, Sticker, Marker Pen, Background, all of these make your photos beautiful or fashion.</p>
<p>Not just collages. Do you wanna make scrapbook with an app? It can help you combine multiple photos into single one, and then print it, print one photo that contains multiple photos can save ink for you, at last paste photos on scrapbook. Or you can edit your photos, after done then print it, bind your photos to an album. Enjoy your D.I.Y album or scrapbook.</p>
<p>Have a question or suggestion? I am waiting for your feedback.<br>Email: leafsupport@163.com</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Alicia" />
          <p class="site-author-name" itemprop="name">Alicia</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">24</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/2027344411/" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:alicialy@qq.com" target="_blank" title="mail">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  mail
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alicia</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/libs/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/libs/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/libs/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/libs/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/libs/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/libs/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
