<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/libs/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/libs/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Leaf Photo, iOS" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Alicia's Blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Alicia's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Alicia's Blog">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6267334170712737000,
      author: 'Alicia'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/3/"/>

  <title> Alicia's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?cbbd9aa76d6f5e7b8019ca96dba4e7e2";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Alicia's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">［LEAF Photo］作者</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/15/Things-you-should-do-before-writing-an-iOS-app/" itemprop="url">
                  Things you should do before writing an iOS app
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-15T10:42:39+08:00" content="2016-05-15">
              2016-05-15
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>创建 iOS 项目之前不要忘记做好以下事情</p>
<h2 id="设置编码规范"><a href="#设置编码规范" class="headerlink" title="设置编码规范"></a>设置编码规范</h2><p>一些编码规范推荐</p>
<p>ObjC</p>
<p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/CodingGuidelines/CodingGuidelines.html">Apple 的 Cocoa 编码规范</a><br><a href="https://github.com/github/objective-c-style-guide">GitHub 基于 Apple Cocoa 的编码规范</a><br><a href="https://google.github.io/styleguide/objcguide.xml">Google 的 ObjC 编码规范(需翻墙)</a><br><a href="https://github.com/NYTimes/objective-c-style-guide">纽约时报的编码规范</a></p>
<p>Swift</p>
<p><a href="https://github.com/raywenderlich/swift-style-guide">Raywenderlich 官方编码规范</a><br><a href="https://github.com/github/swift-style-guide">GithHub 的编码规范</a></p>
<h2 id="确定架构"><a href="#确定架构" class="headerlink" title="确定架构"></a>确定架构</h2><p>使用传统的 MVC 还是 MVVM 亦或是 VIPER</p>
<h2 id="为项目命名，使用公司及项目名作为前缀，最好是-3-个字母，避免类名冲突"><a href="#为项目命名，使用公司及项目名作为前缀，最好是-3-个字母，避免类名冲突" class="headerlink" title="为项目命名，使用公司及项目名作为前缀，最好是 3 个字母，避免类名冲突"></a>为项目命名，使用公司及项目名作为前缀，最好是 3 个字母，避免类名冲突</h2><h2 id="为项目添加-gitignore"><a href="#为项目添加-gitignore" class="headerlink" title="为项目添加 .gitignore"></a>为项目添加 .gitignore</h2><pre><code># Xcode
## Build generated
build/
DerivedData/
## Various settings
*.pbxuser
!default.pbxuser
*.mode1v3
!default.mode1v3
*.mode2v3
!default.mode2v3
*.perspectivev3
!default.perspectivev3
xcuserdata/
## Other
*.xcuserstate
# CocoaPods
Pods
Podfile.lock
</code></pre>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/05/15/Things-you-should-do-before-writing-an-iOS-app/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/05/What-can-make-Core-Graphics-coding-easy/" itemprop="url">
                  What can make Core Graphics coding easy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-05T10:35:01+08:00" content="2016-05-05">
              2016-05-05
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[LEAF Photo] 这个项目用到太多图形绘制，少不了使用 Core Graphics，因为用法简单所以之前也没什么困扰，但是这个项目中复杂图形和曲线绘制的频繁使用导致查询 API 和计算弧度的时间消耗，如果绘制贝塞尔曲线用 Sketch 画好后再计算控制点太费劲了。今天找到一个好工具 ［PaintCode］，可谓是射鸡屎和程序猿通吃的神器。</p>
<p><img src="http://image.woshipm.com/wp-files/2015/05/3aa286544500.jpg" alt="img"></p>
<p>这个工具最大的好处就是可以像操作［Sketch］一样，可视化的方式操作各种图形，OC 代码就直接生成了，大大滴提高了效率。</p>
<p><img src="http://image.woshipm.com/wp-files/2015/05/123123123-1024x640.png" alt="img"></p>
<p>［Sketch］ 设计好的矢量图形可以导出 SVG 格式，直接拖到［PaintCode］代码就生成了。</p>
<p>它的操作也很简单，常用的功能在顶部，属性设置在右方，不学就能会。摸不到头脑的话可以看看 <a href="http://www.paintcodeapp.com" target="_blank" rel="external">官方文档</a> 或者这个系列的 <a href="http://www.woshipm.com/ucd/154006.html" target="_blank" rel="external">使用介绍</a> 。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/19/Lighter-View-Controllers-For-LEAFPhoto/" itemprop="url">
                  Lighter View Controllers For LEAFPhoto
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-19T19:15:52+08:00" content="2016-04-19">
              2016-04-19
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>[LEAF Photo] 整个 app 的大部分功能都是在 LPCollageViewController 中实现的，随着时间的推移，这个 Controller 开始变得臃肿代码很长，记录下瘦身的各种策略。</p>
<h2 id="ViewModel-及组合模式的使用"><a href="#ViewModel-及组合模式的使用" class="headerlink" title="ViewModel 及组合模式的使用"></a>ViewModel 及组合模式的使用</h2><p>[LEAF Photo] 为用户提供了拼接图片的不同模板，模板中包含了选择照片的视图、文字视图以及线条等，模板以 json 文件方式保存，将这些元素显示到视图上简单的逻辑就是判断 json 中是否存在节点，如果存在则创建对应的元素，这样创建模板的过程就会变的臃肿。</p>
<p>借鉴下 MVVM 的方式，将 MVC 中的 C 拆分成 VM，使用 ViewModel 的方式处理展示，在利用组合的方式将每种元素的展示方法拆分到各自类中实现，这样创建元素的这个冗长的过程就可以被分散到每个元素的 ViewModel 类中了。</p>
<pre><code>@interface CollageComponentViewModel : NSObject
- (void)showToView:(CollageContainerView *)view target:(id)target;
@end
@interface CollageViewModel : CollageComponentViewModel
@end
@implementation CollageViewModel
- (instancetype)initWithCollageModel:(CollageModel *)collageModel {
    self = [super init];
    if (self) {
        _collageModel = collageModel;
    }
    return self;
}
- (void)showToView:(CollageContainerView *)view target:(id)target {
    NSArray *textDecArray = self.collageModel.textDec;
    if (textDecArray) {
        [self showToView:view target:target array:textDecArray];
    }
    // ...
}
@end
@interface CollageTextDecViewModel : CollageComponentViewModel
@end
- (void)showToView:(CollageContainerView *)view target:(id)target {
    CollageLabel *textLabel = [[CollageLabel alloc] initWithFrame:frame];
    textLabel.text = self.collageTextDecModel.text;
    textLabel.font = [UIFont fontWithName:self.collageTextDecModel.fontName size:fontSize];
    // ...
    [view addSubview:textLabel];
}
</code></pre><p>原本在 Controller 和 View 中的很多代码，被分散到 CollageTextDecViewModel 等 ViewModel 中去。</p>
<p>除了此例外，通常的应用中一些网络请求的处理和页面设置也可以使用 ViewModel 的方式。</p>
<h2 id="将子视图独立成单独的类"><a href="#将子视图独立成单独的类" class="headerlink" title="将子视图独立成单独的类"></a>将子视图独立成单独的类</h2><p>子视图独立成一个类，并使用懒加载的方式创建。<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/04/19/Lighter-View-Controllers-For-LEAFPhoto/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/01/What-I-Talk-About-When-I-Talk-About-Leaks/" itemprop="url">
                  What I Talk About When I Talk About Leaks
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-01T21:42:09+08:00" content="2016-04-01">
              2016-04-01
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近为［伯乐在线］翻译一篇文章（该文章尚未发布），作者 Russ Bishop 谈到自己查找内存泄漏的一次痛苦经历，读后很有感触，但是那些对于 Instruments 使用不太熟练的读者可能由于 Bishop 忽略了一些细节，看后估计会觉得喝白水般不能解渴，所以写一篇自己的经历将 Bishop 忽略的细节补全作为“译后感”吧。</p>
<h2 id="一种麻烦的检查内存泄漏方式"><a href="#一种麻烦的检查内存泄漏方式" class="headerlink" title="一种麻烦的检查内存泄漏方式"></a>一种麻烦的检查内存泄漏方式</h2><p>为什么麻烦还要介绍呢，因为看到有人这样调试的。这种方式需要写些代码，这些代码完全是调试用的，而且只能让你知道是否存在泄漏，但是无法定位，看看这种方式如何操作。</p>
<p>在 dealloc 方法中写一个日志，如果退出页面的时候能够打印出日志内容，说明该页面没有问题，如果没有打印，那么就是有问题的。</p>
<pre><code>- (void)dealloc {
     DLog(@&quot;release&quot;);
 }
</code></pre><p>这样如果页面中有输出 release，说明该页面 CollageViewController 是没有内存泄漏的</p>
<pre><code>2016-04-01 12:51:56.992 [267:19048] -[CollageViewController dealloc] - [Line 88] -- release
</code></pre><p>但是如果故意把循环引用引入，这个时候会有 Warning 警告，同时 release 也不会打印了</p>
<pre><code>self.paperSizeView.paperSizeBlock = ^(PaperSizeModel *sizeModel) {
    self.paperSize = sizeModel.paperSize;
}
</code></pre><p>要把 self 改为 WeakSelf。</p>
<p>上面的 DLog 是我常用的一个日志宏，调试的时候能输出函数名称和所在行数，定义如下</p>
<pre><code>#ifdef DEBUG
#define DLog(args, ...) NSLog((@&quot;%s - [Line %d] -- &quot; args), __FUNCTION__, __LINE__, ##__VA_ARGS__);
#else
#   define DLog(...)
#endif
</code></pre><p>如果觉得这样的方式输入的内容还不够丰富，建议使用 <a href="https://onevcat.com/2014/01/black-magic-in-macro/">喵神的代码</a></p>
<pre><code>#define NSLog(format, ...) do { \
    fprintf(stderr, &quot;&lt;%s : %d&gt; %s\n&quot;,  \
    [[[NSString stringWithUTF8String:__FILE__] lastPathComponent] UTF8String], \
    __LINE__, __func__);  \
   (NSLog)((format), ##__VA_ARGS__);   \
   fprintf(stderr, &quot;-------\n&quot;);       \
} while (0)
</code></pre><p>注意，这种方式在某些情况下仍然能执行 dealloc，并不是十分可靠，还要确认 Instruments 的 Leaks 下没有报错才可以，例如以下这种比较常见的循环引用，需要使用 Leaks 查看。</p>
<h2 id="常见的循环引用"><a href="#常见的循环引用" class="headerlink" title="常见的循环引用"></a><span id="retain_cylce">常见的循环引用</span></h2><pre><code>@interface RetainCycleModel : NSObject
@property (strong, nonatomic) id obj;
@end


RetainCycleModel *model1 = [[RetainCycleModel alloc] init];
RetainCycleModel *model2 = [[RetainCycleModel alloc] init];

[model1 setObj:model2];
[model2 setObj:model1];
</code></pre><p>上例中 model1 强引用了 model2，model2 又强引用了 model1。<a href="https://github.com/alicialy/MemoryLeaks">Demo 代码点击这里</a></p>
<h2 id="如何用-Instrument-定位隐蔽的循环引用"><a href="#如何用-Instrument-定位隐蔽的循环引用" class="headerlink" title="如何用 Instrument 定位隐蔽的循环引用"></a>如何用 Instrument 定位隐蔽的循环引用</h2><p>还是拿 [LEAF Photo] 举例，运行 Allocation。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/04/01/What-I-Talk-About-When-I-Talk-About-Leaks/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/30/What-I-Talk-About-When-I-Talk-About-Performance/" itemprop="url">
                  What I Talk About When I Talk About Performance
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-30T22:12:34+08:00" content="2016-03-30">
              2016-03-30
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>有一句箴言说：“如果一个产品不注重性能，再华丽也是难用。” ——什么？你没听说过？好吧，这句话是我说的。</p>
<p>要解决一个问题，大多数情况不是我们不知道如何解决，而是我们不知道问题在哪，所以定位问题是非常重要的。突然想到美剧［House］豪斯医生（啊，其实我好久没有看过美剧了，之前太忙了，请忽略我的废话），很多疾病也是很容易解决的，只是那些平庸的医生找不到症结所在。在 iOS 的世界里，查找“病因”的关键工具就是 Instruments 了。这篇文章主要说说如何通过 Instruments 找到问题所在。</p>
<p>另外，由于最近为［伯乐在线］翻译一篇文章（该文章尚未发布），作者 Russ Bishop 谈到自己查找内存泄漏的一次痛苦经历，所以单开一篇文章说如何检测内存泄漏，如果你对下文中的 <em>Allocations &amp; Leaks</em> 章节感觉一览未尽的话，接下来我会写一篇关于调试内存泄漏的文章，里面会讲的更加详尽。</p>
<p>自己设计和编码的项目［LEAF Photo］（一款拼图应用）基本完成等待上线前的收尾工作中，其中有一些优化还是挺有代表性的，就拿它作为 Demo 吧。 </p>
<h2 id="Time-Profiler"><a href="#Time-Profiler" class="headerlink" title="Time Profiler"></a>Time Profiler</h2><p>调优一般我都是从 Time Profiler 开始<br><img src="/post_images/performance1.jpg" alt="img"><br>打开 Time Profiler，将控制面板 Call Tree 中的 Seperate by Thread、 Hide System Libraries 勾选，Invert Call Tree 也可以选中，查看耗时最多的调用，看看是否有可以调整的地方，下面以我的 Demo 为例，谈谈如何调整。</p>
<p>显然，[MainTplTableViewCell setTplCoverModel] 中有些图片处理的耗时操作，这个可以放到线程中去做，使其不影响主线程。</p>
<pre><code>NSString *coverPath = [[NSBundle mainBundle] pathForResource:cover ofType:@&quot;jpg&quot;];
UIImage *tplImage = [UIImage imageWithContentsOfFile:coverPath];
UIImage *scaledImage = [tplImage scaleImageAspectFitToSize:toImageView.bounds.size];
[toImageView setImage:scaledImage];
</code></pre><p>将上面的方法放到线程中，另外由于 imageWithContentsOfFile 方法不会进行缓存，所以加载图片后将其加到缓存 (类型是 NSCache )中。</p>
<pre><code>UIImage *tplImage = [self.cache objectForKey:indexPath];
if (tplImage) {
    [toImageView setImage:tplImage];
}
dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    NSString *coverPath = [[NSBundle mainBundle] pathForResource:cover ofType:@&quot;jpg&quot;];
    UIImage *tplImage = [UIImage imageWithContentsOfFile:coverPath];
    UIImage *scaledImage = [tplImage scaleImageAspectFitToSize:toImageView.bounds.size];
    [self.cache setObject:scaledImage forKey:indexPath];
    dispatch_async(dispatch_get_main_queue(), ^{
        [toImageView setImage:scaledImage];
    });
});
</code></pre><p>这样优化后，setTplCoverModel 方法由原来的 32ms 降低到了 2ms。</p>
<p>通过 Time Profiler 找到最耗时的调用，不影响主线程的操作放到应当线程中；需要优化算法的通过算法降低时间复杂度；经常访问的数据放到缓存中，通过以上方法做调整。</p>
<p>看完 Timer Profiler 接下来看看 Allocations 和 Leaks 的使用。<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/03/30/What-I-Talk-About-When-I-Talk-About-Performance/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/21/Pro-Multilthreading-and-Memory-Management-for-iOS/" itemprop="url">
                  Pro Multilthreading and Memory Management for iOS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-21T20:02:26+08:00" content="2016-03-21">
              2016-03-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Code tells everything，所以直接上代码</p>
<h3 id="ARC"><a href="#ARC" class="headerlink" title="ARC"></a>ARC</h3><h5 id="weak-修饰符的效率"><a href="#weak-修饰符的效率" class="headerlink" title="__weak 修饰符的效率"></a>__weak 修饰符的效率</h5><pre><code>{
    id __weak o = obj; 
    NSLog(@&quot;1 %@&quot;, o); 
    NSLog(@&quot;2 %@&quot;, o); 
}
</code></pre><p>当使用 __weak 修饰符的时候，对象会被自动加到自动释放池里，这样自动释放池能将其自动释放，调用多次 weak 对象，对象就会被多次放到自动释放池中，如上 o 被加入两次，所以建议使用添加加一个强引用来优化如下：</p>
<pre><code>{
    id __weak o = obj; 
    id tmp = o; 
    NSLog(@&quot;1 %@&quot;, tmp); 
    NSLog(@&quot;2 %@&quot;, tmp);
}
</code></pre><h5 id="weak-如何在释放时赋值为-nil"><a href="#weak-如何在释放时赋值为-nil" class="headerlink" title="__weak 如何在释放时赋值为 nil"></a>__weak 如何在释放时赋值为 nil</h5><pre><code>{
    id __weak obj1 = obj;
}
</code></pre><p>以上代码 clang 后为</p>
<pre><code>id obj1;
objc_initWeak(&amp;obj1, obj); 
</code></pre><p>objc_initWeak 定义如下</p>
<pre><code>id objc_initWeak(id *location, id newObj) {
    if (!newObj) {
        *location = nil;
        return nil;
    }
    //  这里的 template 用法是非类型的类模板参数 
    return storeWeak&lt;false/*old*/, true/*new*/, true/*crash*/&gt;
        (location, (objc_object*)newObj);
}
</code></pre><p>关于上面 非类型的类模板参数 也有叫非类型形参，可以优化性能，但是具体原因网上没搜索到，有空看看 《C++ Templates》 应该有具体介绍，可以探究下提升性能的原因。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/03/21/Pro-Multilthreading-and-Memory-Management-for-iOS/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/11/Source-Code-Learning-AFNetworking/" itemprop="url">
                  Source Code Learning - AFNetworking
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-01-11T19:41:33+08:00" content="2016-01-11">
              2016-01-11
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="NSURLSession-的最简单实用方法"><a href="#NSURLSession-的最简单实用方法" class="headerlink" title="NSURLSession 的最简单实用方法"></a>NSURLSession 的最简单实用方法</h2><p>NSURLSession的不同之处在于，它把 NSURLConnection替换为NSURLSession, NSURLSessionConfiguration，以及3个NSURLSessionTask的子类：NSURLSessionDataTask, NSURLSessionUploadTask, 和NSURLSessionDownloadTask</p>
<pre><code>NSURLSessionConfiguration *config = [NSURLSessionConfiguration defaultSessionConfiguration];

NSOperationQueue *queue = [NSOperationQueue mainQueue];
NSURLSession *session = [NSURLSession sessionWithConfiguration:config delegate:self delegateQueue:queue];

NSURLSessionDownloadTask *task = [session downloadTaskWithURL:[NSURL URLWithString:@&quot;https://www.baidu.com&quot;]];
[task resume];
</code></pre><p>可以用这个最简单的例子跟 AF 对比下，看看别人怎么写一个库</p>
<h2 id="KVO-的手动触发"><a href="#KVO-的手动触发" class="headerlink" title="KVO 的手动触发"></a>KVO 的手动触发</h2><pre><code>- (void)setAllowsCellularAccess:(BOOL)allowsCellularAccess {
    [self willChangeValueForKey:NSStringFromSelector(@selector(allowsCellularAccess))];

    _allowsCellularAccess = allowsCellularAccess;

    [self didChangeValueForKey:NSStringFromSelector(@selector(allowsCellularAccess))];
}
</code></pre><p>KVO 手动触发和自动触发不是互斥的，如果需要控制某些变量手动触发，某些自动触发，需要重载 automaticallyNotifiesObserversForKey 方法</p>
<pre><code>(BOOL)automaticallyNotifiesObserversForKey:(NSString *)theKey {
    BOOL automatic = NO;
    if ([theKey isEqualToString:@&quot;balance&quot;]) {
        automatic = NO;
    } else {
        automatic = [super automaticallyNotifiesObserversForKey:theKey];
    }
    return automatic;
}
</code></pre><h2 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h2><p>NS_REQUIRES_NIL_TERMINATION ：是一个宏，用于编译时非 nil 结尾的检查</p>
<pre><code>- (void)print:(NSString *)firstArg, ... NS_REQUIRES_NIL_TERMINATION {
    if (firstArg) {
        NSLog(@&quot;%@&quot;, firstArg);

        va_list args;
        NSString *arg;
        va_start(args, firstArg);
        while ((arg = va_arg(args, NSString *))) {
            NSLog(@&quot;%@&quot;, arg);
        }
        va_end(args);
    }
}
</code></pre><p>调用时要以 nil 作为结尾标志 [instance print:@”a”, @”b”, nil];</p>
<h2 id="常量的定义"><a href="#常量的定义" class="headerlink" title="常量的定义"></a>常量的定义</h2><p>AF 中找不到任何宏定义的字符串、数字、数组，都是使用静态常量</p>
<p>数组：</p>
<pre><code>static NSArray * AFHTTPRequestSerializerObservedKeyPaths() {
    static NSArray *_AFHTTPRequestSerializerObservedKeyPaths = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        _AFHTTPRequestSerializerObservedKeyPaths = @[NSStringFromSelector(@selector(allowsCellularAccess)), NSStringFromSelector(@selector(cachePolicy)), NSStringFromSelector(@selector(HTTPShouldHandleCookies)), NSStringFromSelector(@selector(HTTPShouldUsePipelining)), NSStringFromSelector(@selector(networkServiceType)), NSStringFromSelector(@selector(timeoutInterval))];
    });
    return _AFHTTPRequestSerializerObservedKeyPaths;
}
</code></pre><p>字符串、数字等</p>
<pre><code>static NSString * const kAFMultipartFormCRLF = @&quot;\r\n&quot;;
NSUInteger const kAFUploadStream3GSuggestedPacketSize = 1024 * 16;
</code></pre><h2 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h2><p>参数不能为空的地方不要忘了使用断言</p>
<pre><code>NSParameterAssert(fileURL);
</code></pre><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://link.jianshu.com/?t=https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOCompliance.html#//apple_ref/doc/uid/20002178-SW3" target="_blank" rel="external">KVO Manual Change Notification</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/18/Source-Code-Learning-YYKit/" itemprop="url">
                  Source Code Learning - YYKit
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-12-18T21:44:20+08:00" content="2015-12-18">
              2015-12-18
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="微博-Demo-性能的优化"><a href="#微博-Demo-性能的优化" class="headerlink" title="微博 Demo 性能的优化"></a>微博 Demo 性能的优化</h2><p>抛弃了以往在 Controller 中保存 Model 数组的传统方法，而是添加了用于存放布局和数据对象的数组，其中的布局是从 API 获取到数据后，在后台线程中计算后并保存的，这样当 Cell 需要显示时直接从内存中获取，不需要再进行计算。优点显而易见，缺点是 UIKit 的控件不是线程安全的，所以依赖 YYText 中的控件实现。</p>
<p>头像图片的圆角实现方式是在图片下载后，使用 Core Graphic 将图片用贝塞尔路径切成圆角后放到内存中使用。YYKit 的 Base 下有常用的 Category 实现，其中包括了切圆角的实现。</p>
<h2 id="Macros-宏"><a href="#Macros-宏" class="headerlink" title="Macros 宏"></a>Macros 宏</h2><p>TARGET_INTERFACE_BUILDER 宏用于区分代码是否需要在 IB 中执行</p>
<pre><code>#if !TARGET_INTERFACE_BUILDER
    // this code will run in the app itself
#else
    // this code will execute only in IB
#endif
</code></pre><h2 id="事务机制"><a href="#事务机制" class="headerlink" title="事务机制"></a>事务机制</h2><p>在非 IB 中设置的 YYTextView 需要更新布局时使用了事务机制</p>
<pre><code>[[YYTransaction transactionWithTarget:self selector:@selector(_updateIfNeeded)] commit];
</code></pre><p>事务提交时调用 YYTransactionSetup </p>
<pre><code>static void YYTransactionSetup() {
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        transactionSet = [NSMutableSet new];
        CFRunLoopRef runloop = CFRunLoopGetMain();
        CFRunLoopObserverRef observer;

        observer = CFRunLoopObserverCreate(CFAllocatorGetDefault(),
                                           kCFRunLoopBeforeWaiting | kCFRunLoopExit,
                                           true,      // repeat
                                           0xFFFFFF,  // after CATransaction(2000000)
                                           YYRunLoopObserverCallBack, NULL);
        CFRunLoopAddObserver(runloop, observer, kCFRunLoopCommonModes);
        CFRelease(observer);
    });
}
static void YYRunLoopObserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info) {
    if (transactionSet.count == 0) return;
    NSSet *currentSet = transactionSet;
    transactionSet = [NSMutableSet new];
    [currentSet enumerateObjectsUsingBlock:^(YYTransaction *transaction, BOOL *stop) {
        [transaction.target performSelector:transaction.selector];
    }];
}
</code></pre>
          <div class="post-more-link text-center">
            <a class="btn" href="/2015/12/18/Source-Code-Learning-YYKit/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/05/Source-Code-Learning-YYModel/" itemprop="url">
                  Source Code Learning - YYModel
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-12-05T13:04:51+08:00" content="2015-12-05">
              2015-12-05
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>源码看的是 YYKit，因为内容太多所以还是按照功能分开</p>
<h2 id="kCFNull"><a href="#kCFNull" class="headerlink" title="kCFNull"></a>kCFNull</h2><p>NSNull 的用法 Mattt Thompson 说过是将空值存到数组或者字典</p>
<pre><code>NSMutableDictionary *mutableDictionary = [NSMutableDictionary dictionary];
mutableDictionary[@&quot;someKey&quot;] = [NSNull null]; // Sets value of NSNull singleton for `someKey`
NSLog(@&quot;Keys: %@&quot;, [mutableDictionary allKeys]); // @[@&quot;someKey&quot;]
</code></pre><p>kCFNull 这个是什么呢，看定义可以知道</p>
<pre><code>typedef const struct CF_BRIDGED_TYPE(NSNull) __CFNull * CFNullRef;
const CFNullRef kCFNull;    // the singleton null instance
</code></pre><p>看个栗子</p>
<pre><code>NSNull *null1 = (id)kCFNull;
NSNull *null2 = [NSNull null];
</code></pre><p>输出信息</p>
<pre><code>(NSNull *) null1 = 0x0000000107b10af0
(NSNull *) null2 = 0x0000000107b10af0
</code></pre><p>说明 (id)kCFNull 就是 [NSNull null]</p>
<h2 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h2><pre><code>- (id)deepCopy {
    id obj = nil;
    @try {
        obj = [NSKeyedUnarchiver unarchiveObjectWithData:[NSKeyedArchiver archivedDataWithRootObject:self]];
    }
    @catch (NSException *exception) {
         NSLog(@&quot;%@&quot;, exception);
    }
    return obj;
}
</code></pre><p>下面说说浅拷贝和深拷贝。集合类的拷贝分为浅拷贝和深拷贝<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2015/12/05/Source-Code-Learning-YYModel/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/12/How-To-Record-Your-App-With-QuickTime/" itemprop="url">
                  How To Record Your App With QuickTime
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-11-12T10:42:54+08:00" content="2015-11-12">
              2015-11-12
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前为 Github 上的开源项目录制了一个 Demo 的 Gif，因为有些硬盘洁癖，所以没有下载其他录屏工具，使用的是 Mac 自带的 QuickTime，之后将录制的视频转成 Gif，可是隔段时间以后就忘了如何录制了，在此记录下过程。</p>
<p>将程序在你的 iOS 设备上运行，之后打开 QuickTime 进行以下操作：</p>
<ul>
<li>点击 “File” </li>
<li>点击 “New Movie Recording”</li>
<li>在出现的窗口中点击录制按钮旁边的三角箭头，选择你的 iOS 设备，开始录制吧</li>
</ul>
<p><img src="http://d.image.i4.cn/i4web/image//ueditor/php/upload/image/20141215/1418612164200584.png" alt="img"></p>
<p>视频录制后使用 GIFBrewery 工具生成 Gif，该工具可以设置捕捉帧数及图片颜色数量，基本需求都能满足。</p>
<p><a href="https://github.com/sindresorhus/gifski-app" target="_blank" rel="external">Gifski</a> 也是视频转 Gif 的免费工具。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Alicia" />
          <p class="site-author-name" itemprop="name">Alicia</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">34</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/2027344411/" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:alicialy@qq.com" target="_blank" title="mail">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  mail
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alicia</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/libs/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/libs/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/libs/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/libs/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/libs/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/libs/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
